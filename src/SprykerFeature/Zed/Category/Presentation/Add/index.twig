{% extends '@Gui/Layout/layout.twig' %}

{% if widget_title is not defined %}
    {% set widget_title = 'Category Add' %}
{% endif %}

{% if submit_title is not defined %}
    {% set submit_title = 'Add' %}
{% endif %}

{% if idCategory is not defined %}
    {% set idCategory = 0 %}
{% endif %}

{% block head_title -%}
    {{ widget_title | trans }} {% if idCategory > 0 %} : {{ idCategory }} {% endif %}
{%- endblock %}
{% block section_title %}{{ widget_title }}{% endblock %}


{% block content %}

    {% embed '@Gui/Partials/widget.twig' %}

        {% block widget_content %}

            {{ form_start(form) }}
            {{ form_widget(form) }}

            <h3>Selected products</h3>
            <table class="table table-striped table-bordered table-hover " id="assignNewProductsTable" >
            <thead>
                <tr>
                    <th>Name</th>
                    <th>SKU</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody>
            </tbody>
            </table>

            <div class="">
                <a onclick="fnClickAddRow();" href="javascript:void(0);" class="btn btn-primary ">Assign Selected</a>
            </div>
            <br/>
            <br/>
            <br/>

            <h3>Products in this category</h3>
            {{ productCategories | raw }}

            <input type="submit" class="btn btn-primary" value="{{ submit_title | trans }}" />
            {{ form_end(form) }}

        {% endblock %}

    {% endembed %}

{% endblock %}

{% block head_css %}
    {{ parent() }}
{% endblock %}

{% block footer_js %}
    {{ parent() }}
    <script>
        var selectedProducts = {};
        var suggestedProductsFromSelect2 = {};
        
        function fnClickAddRow() {
            var combo = $('#form_products');
            //var selectedProductId = parseInt(combo.val()) || 0;

            var select2Data = combo.select2('data');
            for (var i=0; i<select2Data.length; i++) {
                var currentId = select2Data[i].id;
                var product = null;

                if (selectedProducts.hasOwnProperty(currentId)) {
                    continue;
                }
                
                if (suggestedProductsFromSelect2.hasOwnProperty(currentId)) {
                    product = suggestedProductsFromSelect2[currentId]; 
                }
                
                selectedProducts[product.id] = product.id;
                
                var action = '<div class=""><a onclick="fnClickRemoveRow(this, ' + product.id + ');" href="javascript:void(0);" class="btn btn-xs ">Remove</a></div>';
                
                $('#assignNewProductsTable').dataTable().fnAddData([
                    product.sku,
                    product.name,
                    action
                ]);
            }
        }

        function fnClickRemoveRow(btn, id) {
            var table = $('#assignNewProductsTable').DataTable();
                table
                    .row( $(btn).parents('tr') )
                    .remove()
                    .draw();
            
            delete selectedProducts[id];

            var new_data = $.grep($('#form_products').select2('data'), function (value) {
                return value['id'] != id;
            });
            
            console.log('newData', new_data);
            
            $('#form_products').select2('data', new_data);
            //$('#form_products').val(new_data).trigger("change");
        }
        
        $(document).ready(function() {
            //parent
            $('.spryker-form-select2combobox').select2();
            
            //category products
            $('#form_products').select2({
                ajax: {
                    url: "/category/edit/productCategorySuggestProduct?id-category={{ idCategory }}",
                    dataType: 'json',
                    delay: 250,
                    data: function (params) {
                        return {
                            q: params.term, // search term
                            page: params.page
                        };
                    },
                    processResults: function (data, page) {
                        for (var i=0; i<data.items.length; i++) {
                            suggestedProductsFromSelect2[data.items[i].id] = data.items[i];
                        }
                        
                        return {
                            results: data.items
                        };
                    },
                    cache: true
                },
                escapeMarkup: function (markup) {
                    return markup; // let our custom formatter work
                },
                minimumInputLength: 2,
                templateResult: function(product) {
                    if (product.loading) return product.text;
                    
                    var markup = 
                            '<div class="clearfix">' +
                                '<div class="col-sm-10">' +
                                '<div class="clearfix">' +
                                    '<div class="col-sm-7"><b class="">' + product.name + '</b> </div>' +
                                    '<div class="col-sm-3"><i class=""> ' + product.sku + '</i></div>' +
                                '</div>'+
                            '<div>';

/*                    if (product.description) {
                        markup += '<div>' + product.description + '</div>';
                    }*/

                    return markup;
                },
                templateSelection: function(product) {
                    return product.name || product.text;
                }
            }).on("change", function(e) {
                // mostly used event, fired to the original element when the value changes
                console.log("change val=" , $(this).select2('data'));
                
            });

        });
    </script>
{% endblock %}
