{% extends '@Gui/Layout/layout.twig' %}

{% if widget_title is not defined %}
    {% set widget_title = 'Category Add' %}
{% endif %}

{% if submit_title is not defined %}
    {% set submit_title = 'Add' %}
{% endif %}

{% if idCategory is not defined %}
    {% set idCategory = 0 %}
{% endif %}

{% block head_title -%}
    {{ widget_title | trans }} {% if idCategory > 0 %} : {{ idCategory }} {% endif %}
{%- endblock %}
{% block section_title %}{{ widget_title }}{% endblock %}


{% block content %}

    {% embed '@Gui/Partials/widget.twig' %}

        {% block widget_content %}

            {{ form_start(form) }}
            {{ form_widget(form) }}

            <h3>Selected products</h3>
            <table class="table table-striped table-bordered table-hover " id="assignNewProductsTable" >
            <thead>
                <tr>
                    <th>Name</th>
                    <th>SKU</th>
                    <th>Preconfig</th>
                    <th></th>
                </tr>
            </thead>
            <tbody>
            </tbody>
            </table>

            <div class="">
                <a onclick="fnClickAddRow();" href="javascript:void(0);" class="btn btn-primary ">Assign Selected</a>
            </div>
            

            <h3>Products in this category</h3>
            {{ productCategories | raw }}

            <input type="submit" class="btn btn-primary" value="{{ submit_title | trans }}" />
            {{ form_end(form) }}

        {% endblock %}

    {% endembed %}

{% endblock %}

{% block head_css %}
    {{ parent() }}
{% endblock %}

{% block footer_js %}
    {{ parent() }}
    <script>
        function fnClickAddRow() {
            var selectedProductId = parseInt($('#form_products').val()) || 0;
            alert(selectedProductId)
            if (selectedProductId <= 0) {
                return;
            }

            $('#assignNewProductsTable').dataTable().fnAddData( [
                'SKU',
                'Name',
                '',
                '<div class=""><a onclick="fnClickRemoveRow(this);" href="javascript:void(0);" class="btn btn-xs ">Remove</a></div>'
            ]);
        }

        function fnClickRemoveRow(btn) {
            //var $table = $('#assignNewProductsTable')
            $(this).parents('tr').remove();
        }
        
        $(document).ready(function() {

            //parent
            $('.spryker-form-select2combobox').select2();
            
            //category products
            $('#form_products').select2({
                ajax: {
                    url: "/category/edit/productCategorySuggestProduct?id-category={{ idCategory }}",
                    dataType: 'json',
                    delay: 250,
                    data: function (params) {
                        return {
                            q: params.term, // search term
                            page: params.page
                        };
                    },
                    processResults: function (data, page) {
                        return {
                            results: data.items
                        };
                    },
                    cache: true
                },
                escapeMarkup: function (markup) {
                    return markup; // let our custom formatter work
                },
                minimumInputLength: 2,
                templateResult: function(product) {
                    if (product.loading) return product.text;
                    
                    var markup = 
                            '<div class="clearfix">' +
                                '<div class="col-sm-10">' +
                                '<div class="clearfix">' +
                                    '<div class="col-sm-7"><b class="">' + product.name + '</b> </div>' +
                                    '<div class="col-sm-3"><i class=""> ' + product.sku + '</i></div>' +
                                '</div>'+
                            '<div>';

/*                    if (product.description) {
                        markup += '<div>' + product.description + '</div>';
                    }*/

                    return markup;
                },
                templateSelection: function(product) {
                    return product.name || product.text;
                }
            });
        });
    </script>
{% endblock %}
